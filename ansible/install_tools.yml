---
- name: Install tools + CloudWatch Agent + Amazon DCV Server
  hosts: all
  become: yes

  vars:
    tools_to_install: []

  tasks:

    - name: Gathering facts
      setup:

    - name: Show detected OS
      debug:
        msg: "Detected {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install dependencies
      apt:
        name:
          - curl
          - jq
          - wget
        state: present

    # -----------------------------------------------------
    # Build ubuntu token like ubuntu2004, ubuntu2204, ubuntu2404
    # -----------------------------------------------------
    - name: Build ubuntu token
      set_fact:
        ubuntu_token: "ubuntu{{ ansible_distribution_major_version }}{{ ansible_distribution_minor_version | default('04') }}"

    - name: Debug ubuntu token
      debug:
        msg: "ubuntu_token = {{ ubuntu_token }}"

    # -----------------------------------------------------
    # DYNAMIC DCV DETECTOR (NEVER FAILS)
    # -----------------------------------------------------
    - name: Detect DCV URL dynamically (latest version)
      shell: |
        #!/bin/sh

        OUT=""

        # 1) fetch CloudFront root listing
        root=$(curl -fsS -m 20 https://d1uj6qtbmh3dt5.cloudfront.net/ 2>/dev/null)

        # 2) get available version directories
        echo "$root" | grep -Eo '[0-9]{4}\.[0-9]+' | sort -V > /tmp/dcv_versions.txt

        last_version=$(tail -n1 /tmp/dcv_versions.txt)

        if [ -z "$last_version" ]; then
          echo ""
          exit 1
        fi

        # 3) get Servers/ listing
        srv=$(curl -fsS -m 20 https://d1uj6qtbmh3dt5.cloudfront.net/$last_version/Servers/ 2>/dev/null)

        # Normalize ubuntu token: ubuntu2004 -> Ubuntu2004
        UB=$(printf '%s\n' "{{ ubuntu_token }}" | sed 's/ubuntu/Ubuntu/')

        echo "$srv" | grep -Eo "$UB" > /tmp/dcv_ubuntu_folder.txt

        ubuntu_folder=$(head -n1 /tmp/dcv_ubuntu_folder.txt)

        if [ -z "$ubuntu_folder" ]; then
          echo ""
          exit 1
        fi

        # 4) get architecture folder
        arch=$(curl -fsS -m 20 https://d1uj6qtbmh3dt5.cloudfront.net/$last_version/Servers/$ubuntu_folder/x86_64/ 2>/dev/null)

        echo "$arch" | grep -Eo 'nice-dcv-server[^"]+\.deb' > /tmp/dcv_debs.txt

        deb=$(head -n1 /tmp/dcv_debs.txt)

        if [ -z "$deb" ]; then
          echo ""
          exit 1
        fi

        # 5) final URL
        echo "https://d1uj6qtbmh3dt5.cloudfront.net/$last_version/Servers/$ubuntu_folder/x86_64/$deb"

      register: dcv_url_raw

    - name: Clean DCV URL
      set_fact:
        DCV_DOWNLOAD_URL: "{{ dcv_url_raw.stdout | trim }}"

    - name: Show final URL
      debug:
        msg: "DCV_DOWNLOAD_URL = {{ DCV_DOWNLOAD_URL }}"

    - name: Fail if URL empty
      fail:
        msg: "DCV URL detection failed!"
      when: DCV_DOWNLOAD_URL | length == 0

    # -----------------------------------------------------
    # Download DCV
    # -----------------------------------------------------
    - name: Download DCV installer
      get_url:
        url: "{{ DCV_DOWNLOAD_URL }}"
        dest: /tmp/dcv.deb
        mode: '0644'
      register: dcv_download

    - name: Install DCV
      apt:
        deb: /tmp/dcv.deb
      when: dcv_download is succeeded

    # -----------------------------------------------------
    # Install optional tools (from Jenkins JSON)
    # -----------------------------------------------------
    - name: Install tools defined in pipeline
      apt:
        name: "{{ item }}"
        state: present
      loop: "{{ tools_to_install }}"
      when: tools_to_install | length > 0

