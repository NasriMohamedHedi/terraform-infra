# ansible/install_tools.yml
- name: Install tools + CloudWatch Agent + NICE DCV + XFCE
  hosts: all
  become: yes

  vars:
    dcv_version: "2024.2-1"
    dcv_pkg_name: "nice-dcv-server_{{ dcv_version }}_amd64.ubuntu2204.deb"
    dcv_download_url: "https://d1uj6qtbmh3dt5.cloudfront.net/{{ dcv_version }}/Servers/Ubuntu22.04/x86_64/{{ dcv_pkg_name }}"

  tasks:

    # ---------------------------------------------------------
    # BASE UPDATE
    # ---------------------------------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    # ---------------------------------------------------------
    # CLOUDWATCH AGENT
    # ---------------------------------------------------------
    - name: Download CloudWatch Agent
      get_url:
        url: https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
        dest: /tmp/amazon-cloudwatch-agent.deb
        mode: '0644'

    - name: Install CloudWatch Agent
      apt:
        deb: /tmp/amazon-cloudwatch-agent.deb
        state: present

    - name: Configure CloudWatch Agent
      template:
        src: amazon-cloudwatch-agent.j2
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        mode: '0644'

    - name: Start CloudWatch Agent
      command: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

    # ---------------------------------------------------------
    # INSTALL CUSTOM TOOLS
    # ---------------------------------------------------------
    - name: Install requested tools
      apt:
        name: "{{ tools_to_install }}"
        state: present
      when: tools_to_install is defined and tools_to_install | length > 0


    # ---------------------------------------------------------
    # DESKTOP (XFCE)
    # ---------------------------------------------------------
    - name: Install XFCE minimal desktop
      apt:
        name:
          - xfce4
          - xfce4-terminal
          - xorg
          - dbus-x11
          - policykit-1
          - lightdm
        state: present
        update_cache: yes


    # ---------------------------------------------------------
    # NICE DCV INSTALLATION
    # ---------------------------------------------------------

    - name: Install DCV dependencies
      apt:
        name:
          - libgl1
          - libxcb-icccm4
          - libxcb-image0
          - libxcb-keysyms1
          - libxcb-randr0
          - libxcb-render-util0
          - libxcb-xinerama0
          - ca-certificates
          - wget
        state: present

    - name: Download DCV package
      get_url:
        url: "{{ dcv_download_url }}"
        dest: "/tmp/{{ dcv_pkg_name }}"
        mode: '0644'
      register: dcv_download
      failed_when: dcv_download.status != 200

    - name: Install DCV
      apt:
        deb: "/tmp/{{ dcv_pkg_name }}"
        state: present

    - name: Enable & start DCV server
      systemd:
        name: dcvserver
        enabled: yes
        state: started

    - name: Add ubuntu user to video group
      user:
        name: ubuntu
        groups: video
        append: yes

    - name: Create default dcv.ini
      copy:
        dest: /etc/dcv/dcv.ini
        content: |
          [license]
          # Leave empty for evaluation mode

          [session-management]
          create-session = true

        owner: root
        group: root
        mode: '0644'

    - name: Restart DCV server
      systemd:
        name: dcvserver
        state: restarted

    - name: Print DCV connection URL
      debug:
        msg: |
          NICE DCV is now running!
          Connect via:
          https://{{ ansible_default_ipv4.address }}:8443

