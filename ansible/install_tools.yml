---
- name: Install tools + MATE GUI + NICE DCV
  hosts: ec2
  become: yes

  vars:
    tools_to_install: []

  tasks:

    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base packages
      apt:
        name:
          - wget
          - curl
          - unzip
          - gpg
          - python3-pip
        state: present

    # --------------------------
    # INSTALL MATE DESKTOP (BEST FOR EC2 + DCV)
    # --------------------------
    - name: Install MATE Desktop (full)
      apt:
        name:
          - ubuntu-mate-core
          - ubuntu-mate-desktop
        state: present

    - name: Ensure systemd default target is graphical
      file:
        src: /lib/systemd/system/graphical.target
        dest: /etc/systemd/system/default.target
        state: link
        force: yes

    # --------------------------
    # AUTO-DETECT UBUNTU VERSION FOR DCV
    # --------------------------
    - name: Gather OS facts
      ansible.builtin.setup:

    - name: Build Ubuntu version token
      set_fact:
        ubuntu_token: "ubuntu{{ ansible_distribution_major_version }}{{ ansible_distribution_release | regex_replace('[^0-9]', '') }}"
      when: ansible_os_family == "Debian"

    - name: Debug ubuntu token
      debug:
        msg: "Ubuntu token selected: {{ ubuntu_token }}"

    # --------------------------
    # GET LATEST NICE DCV VERSION DYNAMICALLY
    # This scrapes the version index from AWS (safe & supported)
    # --------------------------
    - name: Fetch DCV version index
      shell: |
        curl -s https://d1uj6qtbmh3dt5.cloudfront.net/ | grep -oP '202[0-9]\.[0-9]' | sort -V | tail -1
      register: dcv_version_raw

    - name: Set DCV version
      set_fact:
        dcv_version: "{{ dcv_version_raw.stdout }}"

    - name: Debug final DCV version
      debug:
        msg: "Latest DCV version detected: {{ dcv_version }}"

    # --------------------------
    # CONSTRUCT DOWNLOAD URL
    # --------------------------
    - name: Build DCV download URL
      set_fact:
        dcv_url: "https://d1uj6qtbmh3dt5.cloudfront.net/{{ dcv_version }}/Servers/Ubuntu2004/x86_64/nice-dcv-server_{{ dcv_version }}.{{ ansible_distribution_major_version }}-1_amd64.ubuntu2004.deb"

    - name: Debug final URL
      debug:
        msg: "DCV_INSTALL_URL: {{ dcv_url }}"

    # --------------------------
    # INSTALL DCV SERVER
    # --------------------------
    - name: Download DCV installer
      get_url:
        url: "{{ dcv_url }}"
        dest: /tmp/dcv.deb
      register: dcv_download

    - name: Install DCV server
      apt:
        deb: /tmp/dcv.deb
        state: present
      when: dcv_download is succeeded

    # --------------------------
    # INSTALL USER REQUESTED TOOLS
    # --------------------------
    - name: Install user-requested tools
      apt:
        name: "{{ tools_to_install }}"
        state: present
      when: tools_to_install | length > 0

    - name: Print completion message
      debug:
        msg: "MATE + DCV + Tools installed successfully!"

