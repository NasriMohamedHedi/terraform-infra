---
- name: Install tools and NICE DCV on Ubuntu
  hosts: all
  become: yes

  vars:
    tools_to_install: []
    dcv_package_url: "https://d1uj6qtbmh3dt5.cloudfront.net/2024.0/Servers/Ubuntu2204/x86_64/nice-dcv-server_2024.0-19030-1_ubuntu2204_amd64.deb"
    dcv_package_name: "/tmp/nice-dcv-server.deb"

  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install requested tools
      apt:
        name: "{{ tools_to_install }}"
        state: present
      when: tools_to_install | length > 0

    ####################################################################
    # NICE DCV Installation
    ####################################################################

    - name: Install DCV dependencies
      apt:
        name:
          - python3
          - python3-pip
          - make
          - gcc
          - g++
          - linux-headers-{{ ansible_kernel }}
          - pulseaudio
        state: present
      ignore_errors: yes

    - name: Download DCV package
      get_url:
        url: "{{ dcv_package_url }}"
        dest: "{{ dcv_package_name }}"
        mode: '0644'

    - name: Install NICE DCV server
      apt:
        deb: "{{ dcv_package_name }}"
      ignore_errors: yes

    ####################################################################
    # DCV Verification
    ####################################################################

    - name: Verify DCV package installation
      command: dpkg -l | grep dcv
      register: dcv_check
      failed_when: false

    - name: Print DCV verification output
      debug:
        msg: "{{ dcv_check.stdout_lines }}"

    ####################################################################
    # Enable and start DCV services
    ####################################################################

    - name: Enable and start dcvserver service
      systemd:
        name: dcvserver
        state: started
        enabled: yes
      ignore_errors: yes

    - name: Enable and start dcvagent service
      systemd:
        name: dcvagent
        state: started
        enabled: yes
      ignore_errors: yes

    ####################################################################
    # Final confirmation
    ####################################################################

    - name: Show DCV service status
      command: systemctl status dcvserver
      register: dcv_status
      ignore_errors: yes

    - name: Print DCV service status
      debug:
        msg: "{{ dcv_status.stdout_lines }}"

