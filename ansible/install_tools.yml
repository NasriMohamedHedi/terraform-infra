---
- name: Install XFCE Desktop + Amazon DCV Server + tools (manual URL only)
  hosts: all
  become: yes

  vars:
    # <<<<<<<< SET YOUR URL HERE >>>>>>>>
    dcv_download_url: "https://d1uj6qtbmh3dt5.cloudfront.net/nice-dcv-server-2024.0-14697-ubuntu2204-x86_64.tgz"

    tools_to_install: []     
    dcv_port: 8443

  tasks:

    - name: Ensure apt cache is updated
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base utilities
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - jq
          - ca-certificates
          - apt-transport-https
        state: present

    # Lightweight desktop
    - name: Install XFCE desktop
      ansible.builtin.apt:
        name: xfce4
        state: present

    - name: Install LightDM
      ansible.builtin.apt:
        name: lightdm
        state: present

    - name: Install DCV runtime dependencies
      ansible.builtin.apt:
        name:
          - libgl1
          - libxcb-icccm4
          - libxcb-image0
          - libxcb-keysyms1
          - libxcb-randr0
          - libxcb-render-util0
          - libxcb-xinerama0
        state: present

    # ------------------------------
    #   DCV MANUAL URL ONLY
    # ------------------------------

    - name: Fail if no manual DCV URL provided
      ansible.builtin.fail:
        msg: "You must set dcv_download_url with a direct DCV .deb/.tgz URL"
      when: dcv_download_url is undefined or dcv_download_url | length == 0

    - name: Print DCV URL being used
      ansible.builtin.debug:
        msg: "Using manual DCV URL: {{ dcv_download_url }}"

    - name: Extract filename from URL
      ansible.builtin.set_fact:
        dcv_filename: "{{ dcv_download_url.split('/') | last }}"

    - name: Download DCV package
      ansible.builtin.get_url:
        url: "{{ dcv_download_url }}"
        dest: "/tmp/{{ dcv_filename }}"
        mode: "0644"

    - name: Untar DCV if .tgz
      ansible.builtin.unarchive:
        src: "/tmp/{{ dcv_filename }}"
        dest: /tmp/dcv/
        remote_src: yes
      when: dcv_filename.endswith(".tgz")

    - name: Install DCV server (TGZ installer)
      ansible.builtin.shell: |
        cd /tmp/dcv/nice-dcv-* && ./install-dcv.sh
      when: dcv_filename.endswith(".tgz")

    - name: Install DCV server (.deb)
      ansible.builtin.apt:
        deb: "/tmp/{{ dcv_filename }}"
        state: present
      when: dcv_filename.endswith(".deb")

    - name: Enable DCV service
      ansible.builtin.systemd:
        name: dcvserver
        enabled: yes
        state: started

    - name: Create minimal DCV config
      ansible.builtin.copy:
        dest: /etc/dcv/dcv.ini
        content: |
          [license]
          # license_file = /etc/dcv/nice-dcv-license.lic
        owner: root
        group: root
        mode: '0644'
        force: no

    - name: Allow DCV port via UFW (optional)
      block:
        - name: Install ufw
          ansible.builtin.apt:
            name: ufw
            state: present

        - name: Allow DCV port
          ansible.builtin.ufw:
            rule: allow
            port: "{{ dcv_port }}"
            proto: tcp
      rescue:
        - ansible.builtin.debug:
            msg: "ufw not available â€” ensure security group allows port {{ dcv_port }}"

    - name: Restart DCV
      ansible.builtin.systemd:
        name: dcvserver
        state: restarted

    - name: Install extra tools
      ansible.builtin.apt:
        name: "{{ tools_to_install }}"
        state: present
      when: tools_to_install | length > 0

    - name: Show connection info
      ansible.builtin.debug:
        msg: |
          DCV installed successfully.
          Connect via https://{{ ansible_default_ipv4.address }}:{{ dcv_port }}
          Make sure port {{ dcv_port }} is allowed in AWS SG.

