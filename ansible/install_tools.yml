- name: Fully automatic NICE DCV installation for EC2
  hosts: all
  become: yes

  vars:
    dcv_base_url: "https://d1uj6qtbmh3dt5.cloudfront.net"

  tasks:

    - name: Detect OS family
      set_fact:
        os_family: "{{ ansible_facts.os_family }}"
        os_release: "{{ ansible_facts.distribution_version }}"

    - debug:
        msg: "Detected OS: {{ os_family }} version {{ os_release }}"

    - name: Install required packages
      package:
        name:
          - curl
          - unzip
          - jq
        state: present

    # ðŸ”¥ FIXED â€” Always get the right DCV latest version
    - name: Fetch latest DCV version from official metadata
      shell: |
        curl -s https://d1uj6qtbmh3dt5.cloudfront.net/latest_version.json | jq -r '.server'
      register: dcv_version_raw

    - name: Set DCV version
      set_fact:
        dcv_version: "{{ dcv_version_raw.stdout }}"

    - debug:
        msg: "Latest DCV version is {{ dcv_version }}"

    # ðŸ”¥ FIXED URL LOGIC ACCORDING TO AMAZON STRUCTURE
    - name: Set download URL for Ubuntu
      when: os_family == "Debian"
      set_fact:
        dcv_package: "{{ dcv_base_url }}/{{ dcv_version }}/Servers/Ubuntu22.04/x86_64/nice-dcv-server_{{ dcv_version }}-1_amd64.ubuntu22.04.deb"

    - name: Set download URL for Amazon Linux
      when: os_family == "RedHat"
      set_fact:
        dcv_package: "{{ dcv_base_url }}/{{ dcv_version }}/Servers/EL7/x86_64/nice-dcv-server-{{ dcv_version }}-1.el7.x86_64.rpm"

    - debug:
        msg: "Downloading DCV from: {{ dcv_package }}"

    - name: Download DCV package
      get_url:
        url: "{{ dcv_package }}"
        dest: "/tmp/dcv_package.deb"
      when: os_family == "Debian"

    - name: Download DCV package (RedHat)
      get_url:
        url: "{{ dcv_package }}"
        dest: "/tmp/dcv_package.rpm"
      when: os_family == "RedHat"

    - name: Install DCV (Ubuntu)
      apt:
        deb: "/tmp/dcv_package.deb"
      when: os_family == "Debian"

    - name: Install DCV (RedHat)
      yum:
        name: "/tmp/dcv_package.rpm"
        state: present
      when: os_family == "RedHat"

    - name: Enable and start DCV
      systemd:
        name: dcvserver
        state: started
        enabled: yes

