---
- name: Install Desktop + Amazon DCV Server
  hosts: all
  become: yes

  vars:
    dcv_archive_url: "https://d1uj6qtbmh3dt5.cloudfront.net/2025.0/Servers/nice-dcv-2025.0-20103-ubuntu2204-x86_64.tgz"
    dcv_extract_dir: /tmp/dcv
    dcv_archive_dest: /tmp/dcv.tgz
    dcv_port: 8443
    tools_to_install: []

  tasks:
    - name: Update apt repository
      apt:
        update_cache: yes

    - name: Install dependencies
      apt:
        name:
          - curl
          - wget
          - tar
          - gzip
          - ca-certificates
          - dpkg
        state: present

    - name: Install XFCE desktop
      apt:
        name:
          - xfce4
          - xfce4-terminal
        state: present

    - name: Create DCV extraction directory
      file:
        path: "{{ dcv_extract_dir }}"
        state: directory
        mode: "0755"

    - name: Download DCV archive
      get_url:
        url: "{{ dcv_archive_url }}"
        dest: "{{ dcv_archive_dest }}"
        mode: "0644"

    - name: Extract DCV archive
      unarchive:
        src: "{{ dcv_archive_dest }}"
        dest: "{{ dcv_extract_dir }}"
        remote_src: yes

    - name: Find DCV .deb packages
      find:
        paths: "{{ dcv_extract_dir }}"
        patterns: "*.deb"
      register: dcv_debs

    - name: Install DCV .deb packages
      apt:
        deb: "{{ item.path }}"
        state: present
      loop: "{{ dcv_debs.files }}"

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Detect DCV service unit
      shell: |
        systemctl list-unit-files | grep -i dcv | awk '{print $1}' | head -n 1
      register: dcv_service
      changed_when: false

    - name: Debug service detection
      debug:
        msg: "Detected DCV service: {{ dcv_service.stdout }}"

    - name: Fail if no DCV service detected
      fail:
        msg: "DCV service not found. Installation incomplete."
      when: dcv_service.stdout == ""

    - name: Enable and start DCV service
      systemd:
        name: "{{ dcv_service.stdout }}"
        enabled: yes
        state: started

    - name: Install extra requested tools
      apt:
        name: "{{ tools_to_install }}"
        state: present
      when: tools_to_install | length > 0

    - name: Print DCV connection info
      debug:
        msg: "DCV Server ready: https://{{ ansible_default_ipv4.address }}:{{ dcv_port }}"

