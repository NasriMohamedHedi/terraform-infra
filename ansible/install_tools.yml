---
- name: Install XFCE Desktop + NICE DCV + Tools
  hosts: all
  become: yes

  tasks:

    # -------------------------------------------------------
    # Update system
    # -------------------------------------------------------
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base utilities
      apt:
        name:
          - curl
          - wget
          - jq
          - gpg
        state: present

    # -------------------------------------------------------
    # Install XFCE Desktop (lightweight, FAST)
    # -------------------------------------------------------
    - name: Install XFCE Desktop
      apt:
        name:
          - xfce4
          - xfce4-goodies
        state: present

    - name: Install LightDM display manager
      apt:
        name: lightdm
        state: present

    # -------------------------------------------------------
    # Detect Ubuntu version for DCV
    # -------------------------------------------------------
    - name: Detect Ubuntu version
      set_fact:
        ubuntu_major: "{{ ansible_distribution_major_version }}"
        ubuntu_token: "ubuntu{{ ansible_distribution_version | regex_replace('\\.', '') }}"

    - name: Debug Ubuntu token
      debug:
        msg: "Ubuntu detected: {{ ubuntu_token }}"

    # -------------------------------------------------------
    # Detect LATEST DCV version dynamically
    # -------------------------------------------------------
    - name: Get latest DCV release version
      shell: |
        curl -fsS https://d1uj6qtbmh3dt5.cloudfront.net/ \
        | grep -Eo '[0-9]{4}\.[0-9]+' \
        | sort -V \
        | tail -n1
      register: dcv_version

    - name: Debug DCV version found
      debug:
        msg: "DCV version = {{ dcv_version.stdout }}"

    - name: Find DCV .deb package for Ubuntu
      shell: |
        curl -fsS https://d1uj6qtbmh3dt5.cloudfront.net/{{ dcv_version.stdout }}/Servers/Ubuntu{{ ubuntu_major }}04/x86_64/ \
        | grep -Eo 'nice-dcv-server[^"]+\.deb' \
        | head -n1
      register: dcv_deb

    - name: Build DCV URL
      set_fact:
        dcv_url: "https://d1uj6qtbmh3dt5.cloudfront.net/{{ dcv_version.stdout }}/Servers/Ubuntu{{ ubuntu_major }}04/x86_64/{{ dcv_deb.stdout }}"

    - name: Show final DCV URL
      debug:
        msg: "DCV download: {{ dcv_url }}"

    # -------------------------------------------------------
    # Download + Install DCV
    # -------------------------------------------------------
    - name: Download DCV package
      get_url:
        url: "{{ dcv_url }}"
        dest: "/tmp/dcv.deb"
        mode: "0644"

    - name: Install DCV Server
      apt:
        deb: "/tmp/dcv.deb"
        state: present

    # -------------------------------------------------------
    # Install user-selected tools
    # -------------------------------------------------------
    - name: Install extra tools
      apt:
        name: "{{ tools_to_install }}"
        state: present

