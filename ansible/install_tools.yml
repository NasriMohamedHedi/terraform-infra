---
- name: Configure EC2 instance (Golden AMI)
  hosts: all
  become: yes

  vars:
    tools_to_install: []

  tasks:

  - name: Gather facts
    ansible.builtin.setup:

  # ----------------------------
  # CloudWatch Agent
  # ----------------------------
  - name: Install CloudWatch Agent
    ansible.builtin.apt:
      name: amazon-cloudwatch-agent
      state: present
      update_cache: yes

  - name: Create CloudWatch Agent config directory
    ansible.builtin.file:
      path: /opt/aws/amazon-cloudwatch-agent/etc
      state: directory
      mode: '0755'

  - name: Deploy CloudWatch Agent config
    ansible.builtin.template:
      src: amazon-cloudwatch-agent.j2
      dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
      owner: root
      group: root
      mode: '0644'

  - name: Enable and start CloudWatch Agent
    ansible.builtin.command: >
      /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl
      -a fetch-config
      -m ec2
      -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
      -s

  # ----------------------------
  # Extra tools
  # ----------------------------
  - name: Install requested tools
    ansible.builtin.apt:
      name: "{{ tools_to_install }}"
      state: present
    when: tools_to_install | length > 0

  - name: Final message
    ansible.builtin.debug:
      msg: |
        EC2 configuration finished.
        CloudWatch Agent is running.

