---
- name: Install tools + CloudWatch Agent + DCV + XFCE (auto version)
  hosts: all
  become: yes

  tasks:

    ##################################################################
    # BASE SYSTEM + CLOUDWATCH AGENT
    ##################################################################
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install CloudWatch Agent - download
      get_url:
        url: https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
        dest: /tmp/amazon-cloudwatch-agent.deb
        mode: "0644"

    - name: Install CloudWatch Agent
      apt:
        deb: /tmp/amazon-cloudwatch-agent.deb
        state: present

    - name: Configure CloudWatch Agent
      copy:
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        content: |
          {
            "agent": {
              "metrics_collection_interval": 60,
              "run_as_user": "root"
            },
            "metrics": {
              "namespace": "EC2/CWAgent",
              "metrics_collected": {
                "cpu": { "measurement": ["cpu_usage_idle", "cpu_usage_iowait"], "metrics_collection_interval": 60 },
                "disk": { "measurement": ["used_percent"], "metrics_collection_interval": 60 },
                "mem": { "measurement": ["mem_used_percent"], "metrics_collection_interval": 60 }
              }
            }
          }
        mode: "0644"

    - name: Start CloudWatch Agent
      command: >
        /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl
        -a fetch-config -m ec2 -s
        -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

    ##################################################################
    # INSTALL EXTRA TOOLS IF PROVIDED
    ##################################################################
    - name: Install extra requested tools
      apt:
        name: "{{ tools_to_install }}"
        state: present
      when: tools_to_install is defined

    ##################################################################
    # DESKTOP (XFCE)
    ##################################################################
    - name: Install XFCE
      apt:
        name:
          - xfce4
          - xfce4-terminal
          - xorg
          - dbus-x11
          - policykit-1
          - pulseaudio
        state: present
        update_cache: yes

    - name: Install DCV dependencies
      apt:
        name:
          - libgl1
          - libxcb-icccm4
          - libxcb-image0
          - libxcb-keysyms1
          - libxcb-randr0
          - libxcb-render-util0
          - libxcb-xinerama0
          - ca-certificates
          - wget
          - apt-transport-https
          - gnupg
        state: present

    ##################################################################
    # DETECT LATEST DCV VERSION + CORRECT UBUNTU PATH
    ##################################################################

    - name: Determine Ubuntu short version
      set_fact:
        ubuntu_major: "{{ ansible_distribution_version.split('.')[0] }}"
        ubuntu_minor: "{{ ansible_distribution_version.split('.')[1] }}"

    - name: Build Ubuntu DCV folder name (20.04 or 22.04)
      set_fact:
        ubuntu_dcv_dir: "Ubuntu{{ ubuntu_major }}.{{ ubuntu_minor }}"

    - name: Fetch DCV download index page
      uri:
        url: https://d1uj6qtbmh3dt5.cloudfront.net/
        return_content: yes
      register: dcv_index

    # Extract first version match (fix for earlier list problem)
    - name: Detect latest DCV version dynamically
      set_fact:
        dcv_version_list: "{{ dcv_index.content | regex_findall('(202[0-9]\\.[0-9]+)') }}"

    - name: Extract DCV version from list
      set_fact:
        dcv_version: "{{ dcv_version_list[0] }}"

    - name: Build DCV package filename
      set_fact:
        dcv_pkg: "nice-dcv-server_{{ dcv_version }}_amd64.ubuntu{{ ubuntu_major }}{{ ubuntu_minor }}.deb"

    - name: Build final DCV URL
      set_fact:
        dcv_url: "https://d1uj6qtbmh3dt5.cloudfront.net/{{ dcv_version }}/Servers/{{ ubuntu_dcv_dir }}/x86_64/{{ dcv_pkg }}"

    - name: Debug DCV download URL
      debug:
        msg: "Final DCV URL = {{ dcv_url }}"

    ##################################################################
    # DOWNLOAD + INSTALL DCV
    ##################################################################

    - name: Download DCV server package
      get_url:
        url: "{{ dcv_url }}"
        dest: "/tmp/{{ dcv_pkg }}"
        timeout: 60
        validate_certs: yes

    - name: Install DCV server
      apt:
        deb: "/tmp/{{ dcv_pkg }}"
        state: present

    - name: Enable and start DCV service
      systemd:
        name: dcvserver
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Add ubuntu user to video group
      user:
        name: ubuntu
        groups: video
        append: yes

    - name: Create minimal DCV config if missing
      copy:
        dest: /etc/dcv/dcv.ini
        content: |
          [license]
          [ssl]
        mode: "0644"
        force: no

    - name: Restart DCV service
      systemd:
        name: dcvserver
        state: restarted

    - name: Print connection info
      debug:
        msg: |
          DCV installed successfully.
          Connect via: https://{{ ansible_default_ipv4.address }}:8443

