---
- name: Install tools + CloudWatch Agent + Amazon DCV Server
  hosts: all
  become: yes

  tasks:

    - name: Show detected OS
      debug:
        msg: "Detected {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install dependencies
      apt:
        name:
          - curl
          - wget
          - jq
          - ca-certificates
        state: present

    - name: Build ubuntu token (ubuntu2004 / ubuntu2204 / ubuntu2404)
      set_fact:
        ubuntu_token: "ubuntu{{ ansible_distribution_version | regex_replace('\\.', '') }}"

    - name: Debug ubuntu token
      debug:
        msg: "ubuntu_token = {{ ubuntu_token }}"

    ###########################################################################
    # UNIVERSAL /bin/sh COMPATIBLE DCV URL DETECTOR
    ###########################################################################
    - name: Detect DCV URL from all sources (POSIX safe)
      shell: |
        #!/bin/sh

        OUT=""

        # --- Try amazondcv.com
        page=$(curl -fsS -m 20 https://www.amazondcv.com/ 2>/dev/null)
        if [ -n "$page" ]; then
          echo "$page" | grep -Eo 'https://[^"]*nice-dcv-server[^"]*\.deb' > /tmp/dcv_links.txt 2>/dev/null
          if grep -i "{{ ubuntu_token }}" /tmp/dcv_links.txt >/tmp/dcv_pick.txt 2>/dev/null; then
            OUT=$(head -n1 /tmp/dcv_pick.txt)
          else
            OUT=$(head -n1 /tmp/dcv_links.txt)
          fi
        fi

        # --- Try CloudFront index listing
        if [ -z "$OUT" ]; then
          cf=$(curl -fsS -m 20 https://d1uj6qtbmh3dt5.cloudfront.net/server/ 2>/dev/null)
          echo "$cf" | grep -Eo 'nice-dcv-server[^"]*{{ ubuntu_token }}[^"]*\.deb' > /tmp/cf.txt 2>/dev/null
          OUT=$(head -n1 /tmp/cf.txt)
          if [ -n "$OUT" ]; then
            OUT="https://d1uj6qtbmh3dt5.cloudfront.net/server/$OUT"
          fi
        fi

        # --- FINAL FALLBACK (guaranteed working pattern for major Ubuntu)
        if [ -z "$OUT" ]; then
          case "{{ ubuntu_token }}" in
            ubuntu2004)
              OUT="https://d1uj6qtbmh3dt5.cloudfront.net/2024.1/Servers/Ubuntu2004/x86_64/nice-dcv-server_2024.1.15167-1_amd64.ubuntu2004.deb"
              ;;
            ubuntu2204)
              OUT="https://d1uj6qtbmh3dt5.cloudfront.net/2024.1/Servers/Ubuntu2204/x86_64/nice-dcv-server_2024.1.15167-1_amd64.ubuntu2204.deb"
              ;;
            ubuntu2404)
              OUT="https://d1uj6qtbmh3dt5.cloudfront.net/2024.1/Servers/Ubuntu2404/x86_64/nice-dcv-server_2024.1.15167-1_amd64.ubuntu2404.deb"
              ;;
          esac
        fi

        printf "%s" "$OUT"
      register: dcv_url_raw

    - name: Clean DCV URL (trim spaces)
      set_fact:
        dcv_url: "{{ dcv_url_raw.stdout | trim }}"

    - name: Show final URL (guaranteed not empty)
      debug:
        msg: "DCV_DOWNLOAD_URL = {{ dcv_url }}"

    - name: Fail if URL STILL empty (should never happen)
      fail:
        msg: "DCV download URL empty â€” aborting!"
      when: dcv_url | length < 5

    - name: Download DCV
      get_url:
        url: "{{ dcv_url }}"
        dest: /tmp/dcv.deb
        mode: '0644'

    - name: Install DCV
      apt:
        deb: /tmp/dcv.deb

