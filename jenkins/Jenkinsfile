pipeline {
  agent any

  parameters {
    string(name: 'BUCKET', defaultValue: 'thesamuraibucket', description: 'S3 bucket name')
    string(name: 'KEY',    defaultValue: '',               description: 'S3 object key')
  }

  environment {
    AWS_DEFAULT_REGION = 'eu-central-1'
    JENKINS_URL       = "${params.jenkins_url ?: 'https://9216d38c2a3f.ngrok-free.app'}"
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/NasriMohamedHedi/terraform-infra.git', branch: 'main'
      }
    }

    stage('Terraform Init') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh 'terraform init -input=false -reconfigure'
        }
      }
    }

    stage('Terraform Apply') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh """
            terraform apply \
              -var 's3_payload_bucket=${BUCKET}' \
              -var 's3_payload_key=${KEY}' \
              -var 'jenkins_url=${JENKINS_URL}' \
              -auto-approve
          """
        }
      }
    }

    stage('Generate Key Pair') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh '''
            # Create key if it doesn't exist
            if ! aws ec2 describe-key-pairs \
                  --key-names client-access-key \
                  --region eu-central-1 >/dev/null 2>&1; then

              aws ec2 create-key-pair \
                --key-name client-access-key \
                --region eu-central-1 \
                --query 'KeyMaterial' --output text \
                > /tmp/client-access-key.pem

              chmod 400 /tmp/client-access-key.pem

              # Copy to Jenkins home
              sudo cp /tmp/client-access-key.pem /var/lib/jenkins/client-access-key.pem
              sudo chmod 400 /var/lib/jenkins/client-access-key.pem
            else
              echo "Key pair client-access-key already exists"
            fi
          '''
        }
      }
    }

    stage('Archive Outputs') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh 'terraform output -json > outputs.json'
          archiveArtifacts artifacts: 'outputs.json'
        }
      }
    }

    stage('Send SSH Details') {
  steps {
    // 1) Copy the key into the workspace
    sh 'cp /var/lib/jenkins/client-access-key.pem client-access-key.pem'
    // 2) Archive it so Jenkins will host it under /artifact/
    archiveArtifacts artifacts: 'client-access-key.pem'

    withCredentials([[
      $class: 'AmazonWebServicesCredentialsBinding',
      credentialsId: 'aws-terraform-creds',
      accessKeyVariable: 'AWS_ACCESS_KEY_ID',
      secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
    ]]) {
      script {
        // 3) Correctly pull only the IP addresses
        def ips = sh(
          script: "terraform output -json | jq -r '.ec2_public_ips | .[]'",
          returnStdout: true
        ).trim().split('\n')

        // 4) Build step-by-step SSH commands
        def sshCommands = ips.collectIndexed { idx, ip ->
          "${idx+1}. ssh -i client-access-key.pem ubuntu@${ip}"
        }.join('\n')

        // 5) Pull the email address out of your S3 JSON payload
        def clientEmail = sh(
          script: "aws s3 cp s3://${BUCKET}/${KEY} - | jq -r '.client_email'",
          returnStdout: true
        ).trim()

        // 6) Compute a downloadable URL for the PEM (hosted by Jenkins)
        def downloadUrl = "${env.BUILD_URL}artifact/client-access-key.pem"

        // 7) Send the mail
        mail(
          to:         clientEmail,
          replyTo:    'no‚Äëreply@apollo‚Äëdojo.com',       // avoids ‚Äúaddress not configured‚Äù fallback
          subject:    "üîë Your VM SSH Credentials (Job #${BUILD_NUMBER})",
          body:       """\
Hello,

Your EC2 instance has been deployed. To connect:

${sshCommands}

Next steps:
1. Download your private key:  
   ${downloadUrl}  
2. Secure it:  
   chmod 400 client-access-key.pem  
3. Run the SSH command(s) above.

‚Äî  
The Apollo Dojo Samurai Team
"""
        )
      }
    }
  }
}


  post {
    always {
      sh 'rm -f /tmp/client-access-key.pem outputs.json client-access-key.pem || true'
    }
    success {
      echo "Pipeline completed successfully!"
    }
    failure {
      echo "Pipeline failed. Check logs for details."
    }
  }
}

