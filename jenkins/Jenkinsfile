pipeline {
  agent any

  parameters {
    string(name: 'BUCKET', defaultValue: 'thesamuraibucket', description: 'S3 bucket name')
    string(name: 'KEY',    defaultValue: '',               description: 'S3 object key')
  }

  environment {
    AWS_DEFAULT_REGION = 'eu-central-1'
    JENKINS_URL        = "${params.jenkins_url ?: 'https://9216d38c2a3f.ngrok-free.app'}"
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/NasriMohamedHedi/terraform-infra.git', branch: 'main'
      }
    }

    stage('Terraform Init') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh 'terraform init -input=false -reconfigure'
        }
      }
    }

    stage('Terraform Apply') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh """
            terraform apply \
              -var 's3_payload_bucket=${BUCKET}' \
              -var 's3_payload_key=${KEY}' \
              -var 'jenkins_url=${JENKINS_URL}' \
              -auto-approve
          """
        }
      }
    }

    stage('Generate Key Pair') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh '''
            if ! aws ec2 describe-key-pairs --key-names client-access-key --region eu-central-1 >/dev/null 2>&1; then
              aws ec2 create-key-pair --key-name client-access-key \
                --region eu-central-1 --query 'KeyMaterial' --output text \
                > /tmp/client-access-key.pem

              chmod 400 /tmp/client-access-key.pem
              sudo cp /tmp/client-access-key.pem /var/lib/jenkins/client-access-key.pem
              sudo chmod 400 /var/lib/jenkins/client-access-key.pem
            else
              echo "Key pair client-access-key already exists"
            fi
          '''
        }
      }
    }

    stage('Archive Outputs') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-terraform-creds',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh 'terraform output -json > outputs.json'
          archiveArtifacts artifacts: 'outputs.json'
        }
      }
    }

    stage('Send SSH Details') {
  steps {
    // 1) Copy the key into the workspace and archive it
    sh 'cp /var/lib/jenkins/client-access-key.pem client-access-key.pem'
    archiveArtifacts artifacts: 'client-access-key.pem'

    withCredentials([[
      $class: 'AmazonWebServicesCredentialsBinding',
      credentialsId: 'aws-terraform-creds',
      accessKeyVariable: 'AWS_ACCESS_KEY_ID',
      secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
    ]]) {
      script {
        // 2) Get the opendlp-vm IP
        def ip = sh(
          script: "terraform output -json ec2_public_ips | jq -r '.\"opendlp-vm\"'",
          returnStdout: true
        ).trim()
        if (!ip) error("No IP found for opendlp‚Äëvm")

        // 3) Load the recipient from S3
        def clientEmail = sh(
          script: "aws s3 cp s3://${BUCKET}/${KEY} - | jq -r '.client_email'",
          returnStdout: true
        ).trim()
        if (!clientEmail) error("No client_email in S3 payload")

        // 4) Compute a public download URL using your Jenkins system URL:
        //    Make sure ‚ÄúJenkins URL‚Äù in Manage Jenkins ‚Üí Configure System
        //    is set to your ngrok address (e.g. https://9216d38c2a3f.ngrok-free.app)
        def downloadUrl = "${env.JENKINS_URL}job/${env.JOB_NAME}/${env.BUILD_NUMBER}/artifact/client-access-key.pem"

        // 5) Send via Email‚ÄëExtension with attachment
        emailext(
          to:                 clientEmail,
          replyTo:            'no-reply@apollo-dojo.com',
          subject:            "üîë Your VM SSH Credentials (Build #${BUILD_NUMBER})",
          body:               """\
Hello,

Your EC2 instance is up and running. Follow these steps:

1) Download the private key (attached):
   client-access-key.pem  
   Or via browser: ${downloadUrl}

2) Secure the key:
   chmod 400 client-access-key.pem

3) Connect over SSH:
   ssh -i client-access-key.pem ubuntu@${ip}

Type ‚Äúyes‚Äù if prompted.

Cheers,  
The Apollo Dojo Samurai Team
""",
          attachmentsPattern: 'client-access-key.pem',
          mimeType:           'text/plain'
        )
      }
    }
  }
}


  } // end stages

  post {
    always {
      sh 'rm -f /tmp/client-access-key.pem outputs.json client-access-key.pem || true'
    }
    success {
      echo "Pipeline completed successfully!"
    }
    failure {
      echo "Pipeline failed. Check logs for details."
    }
  }

} // end pipeline

